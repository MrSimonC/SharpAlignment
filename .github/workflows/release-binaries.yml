name: ğŸš€ Release Binaries

on:
  push:
    branches:
      - master
      - main
    paths:
      - sharpalignment-tool/Directory.Build.props
  workflow_dispatch:

permissions:
  contents: write

jobs:
  detect-version:
    name: ğŸ” Detect version change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changed: ${{ steps.version.outputs.changed }}
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          version="$(sed -n 's:.*<Version>\(.*\)</Version>.*:\1:p' sharpalignment-tool/Directory.Build.props | head -n 1)"
          if [ -z "$version" ]; then
            echo "Failed to parse <Version> from sharpalignment-tool/Directory.Build.props"
            exit 1
          fi

          previous_version=""
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            previous_version="$(git show "${{ github.event.before }}:sharpalignment-tool/Directory.Build.props" 2>/dev/null | sed -n 's:.*<Version>\(.*\)</Version>.*:\1:p' | head -n 1 || true)"
          fi

          changed="true"
          if [ -n "$previous_version" ] && [ "$previous_version" = "$version" ]; then
            changed="false"
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "changed=$changed" >> "$GITHUB_OUTPUT"

  publish-release:
    name: ğŸ“¦ Publish binaries
    runs-on: ubuntu-latest
    needs: detect-version
    if: ${{ needs.detect-version.outputs.changed == 'true' || github.event_name == 'workflow_dispatch' }}
    env:
      VERSION: ${{ needs.detect-version.outputs.version }}
    steps:
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ£ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: ğŸ§ª Validate internal version
        shell: bash
        run: |
          set -euo pipefail
          dotnet build sharpalignment-tool/SharpAlignment.Console/SharpAlignment.Console.csproj -c Release
          actual="$(dotnet sharpalignment-tool/SharpAlignment.Console/bin/Release/net10.0/sharpalignment.dll --version | tr -d '\r\n')"
          if [ "$actual" != "$VERSION" ]; then
            echo "Internal binary version '$actual' does not match release version '$VERSION'."
            exit 1
          fi

      - name: ğŸ“¦ Publish Linux self-contained single-file
        run: >
          dotnet publish sharpalignment-tool/SharpAlignment.Console/SharpAlignment.Console.csproj
          -c Release
          -r linux-x64
          --self-contained true
          -p:PublishSingleFile=true
          -o artifacts/release/linux-x64

      - name: ğŸ“¦ Publish Windows self-contained single-file
        run: >
          dotnet publish sharpalignment-tool/SharpAlignment.Console/SharpAlignment.Console.csproj
          -c Release
          -r win-x64
          --self-contained true
          -p:PublishSingleFile=true
          -o artifacts/release/win-x64

      - name: ğŸ·ï¸ Prepare release files
        shell: bash
        run: |
          set -euo pipefail
          chmod +x artifacts/release/linux-x64/sharpalignment

      - name: ğŸ“¤ Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: sharpalignment-${{ env.VERSION }}
          path: |
            artifacts/release/linux-x64/sharpalignment
            artifacts/release/win-x64/sharpalignment.exe
          if-no-files-found: error
          retention-days: 7

      - name: ğŸš€ Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: sharpalignment-v${{ env.VERSION }}
          name: sharpalignment v${{ env.VERSION }}
          generate_release_notes: true
          files: |
            artifacts/release/linux-x64/sharpalignment
            artifacts/release/win-x64/sharpalignment.exe
